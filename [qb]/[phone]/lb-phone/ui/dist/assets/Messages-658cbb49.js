var Re=Object.defineProperty;var _e=(t,n,E)=>n in t?Re(t,n,{enumerable:!0,configurable:!0,writable:!0,value:E}):t[n]=E;var Z=(t,n,E)=>(_e(t,typeof n!="symbol"?n+"":n,E),E);import{r as m,j as e,F as ie,a as o}from"./jsx-runtime-f40812bf.js";import{f as k,u as ee,v as be,L as r,j,k as Ve,w as Ce,I as re,C as F,g as te,d as X,x as Ae,n as x,t as $e,y as ge,b as q,z as Fe,A as Ne,B as le,h as Ye,m as je,o as Te,i as K,D as xe,E as He}from"./Phone-d66a2975.js";import{u as y,P as me,a0 as Xe,ah as Be,b as de,X as Ge,ai as qe,e as we,aj as Qe,G as We,a as ze,m as ce,ak as Ke,aa as Je,ab as Ze,al as et,x as tt,s as Oe,T as st,am as at}from"./index.esm-9527ffc7.js";import{r as ve,f as Me}from"./number-28525126.js";const pe=(t,n=25,E=7,C=360,f=120)=>new Promise((a,i)=>{let l=document.createElement("canvas");l.width=C,l.height=f;let u=l.getContext("2d");u.fillStyle="#000";let N=new AudioContext;t.arrayBuffer().then(c=>N.decodeAudioData(c)).then(c=>{let d=(l.width-(n-1)*E)/n,g=l.height/2,I=Math.floor(c.length/n),S=c.getChannelData(0);for(let G=0;G<n;G++){let D=1,_=.1;for(let w=0;w<I;w++){let b=S[G*I+w];b<D&&(D=b),b>_&&(_=b)}let V=(1+D)*g,$=(_-D)*g;u.beginPath(),u.moveTo(G*(d+E),V),u.lineTo(G*(d+E),V+$),u.lineTo(G*(d+E)+d,V+$),u.lineTo(G*(d+E)+d,V),u.closePath(),u.fill()}l.toBlob(G=>a({blob:G,base64:l.toDataURL()}))})});class nt{constructor(){Z(this,"recorder");Z(this,"chunks");Z(this,"stream");Z(this,"mute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!1)});Z(this,"unmute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!0)});this.recorder=null,this.chunks=[]}start(n){this.stream=n,this.recorder=new MediaRecorder(n),this.recorder.ondataavailable=E=>this.chunks.push(E.data),this.chunks=[],this.recorder.start(),k("isTalking").then(E=>{E?this.unmute():this.mute()})}stop(){const{recorder:n,chunks:E}=this;return new Promise(C=>{n.onstop=()=>{const f=new Blob(E,{type:n.mimeType}),a=new Audio;a.src=URL.createObjectURL(f),this.stream&&this.stream.getTracks().forEach(l=>l.stop());let i={blob:f};pe(f).then(l=>{pe(f,60,7,960,200).then(u=>{i.waveform={message:l.blob,placeholder:u.base64},a.duration===1/0?(a.currentTime=Number.MAX_SAFE_INTEGER,a.ontimeupdate=()=>C({...i,duration:Math.floor(a.duration+.5)})):C({...i,duration:Math.floor(a.duration+.5)})})})},n.stop()})}}function rt(){const{User:t,View:n,UnreadMessages:E}=m.useContext(se),C=y(q.Settings),f=y(q.PhoneNumber),[a,i]=t,[l,u]=n,[N,c]=E,d=y(F.Emoji),[g,I]=m.useState(!1),[S,G]=m.useState(null),[D,_]=m.useState(!1),[V,$]=m.useState(!1),[w,b]=m.useState(0),[J,B]=m.useState(0),[P,O]=m.useState(!1),[R,p]=m.useState(!1),[v,M]=m.useState([]),[A,U]=m.useState(null),ae=m.useRef(null),ue=m.useRef(0),[Y,ne]=m.useState({content:"",attachments:[]}),H=y(te);m.useEffect(()=>{k("Messages",{action:"getMessages",page:0,id:a.id}).then(s=>{s&&s.length>0?M([...s.reverse()]):O(!0)})},[]);const oe=m.useRef(!1),Se=()=>{if(!ye(Y.content))return X("error","Message contains invalid characters, returning");if(Y.content.length>0||Y.attachments.length>0||A){let s={sender:f,timestamp:Date.now(),id:a.id,content:Y.content,attachments:Y.attachments};if(C.airplaneMode)return M(h=>[...h,{...s,delivered:!1}]);if(A){if(oe.current)return;oe.current=!0,Ae("Image",A.waves.message).then(h=>{Ae("Audio",A.blob).then(T=>{s.content=`<!AUDIO-MESSAGE-IMAGE="${h}"-AUDIO="${T}"-DURATION="${A.duration}"!>`,k("Messages",{action:"sendMessage",number:a.number,content:s.content,id:a.id}).then(L=>{M(L?z=>[...z,s]:z=>[...z,{...s,delivered:!1}]),oe.current=!1,U(null)})})});return}if(A)return;k("Messages",{action:"sendMessage",number:a.number,content:Y.content,attachments:Y.attachments,id:a.id}).then(h=>{h?(M(T=>[...T,s]),U(null)):M(T=>[...T,{...s,delivered:!1}]),ne({content:"",attachments:[]}),ae.current&&(ae.current.value=""),X("info","Updating recent message cache state"),x.APPS.MESSAGES.messages.set(x.APPS.MESSAGES.messages.value.map(T=>T.id===a.id?{...T,timestamp:new Date().getTime(),lastMessage:s.content,unread:!1,deleted:!1}:T))})}},Ee=s=>{if(H.EnableMessagePay&&!(!s&&s<=0)){if(s>((H==null?void 0:H.MaxTransferAmount)??Number.MAX_SAFE_INTEGER))return X("error","Amount is too high");F.PopUp.set({title:r("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:H.CurrencyFormat.replace("%s",s.toString())}),description:r("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:H.CurrencyFormat.replace("%s",s.toString()),name:a.name??j(a.number)}),buttons:[{title:r("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:r("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{k("Wallet",{action:"sendPayment",number:a.number,amount:s}).then(h=>{if(!h.success){X("error","Failed to send payment "+JSON.stringify(h)),setTimeout(()=>{F.PopUp.set({title:r("APPS.MESSAGES.PAYMENT_FAILED_POPUP.TITLE"),description:r("APPS.MESSAGES.PAYMENT_FAILED_POPUP.DESCRIPTION").format({error:h.reason}),buttons:[{title:r("APPS.MESSAGES.PAYMENT_FAILED_POPUP.CLOSE")}]})},500);return}let T={id:a.id,sender:f,content:`<!SENT-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};M(L=>[...L,T])})}}]})}},Ie=s=>{if(!H.EnableMessagePay||!s&&s<=0)return;let h={sender:f,content:`<!REQUESTED-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};k("Messages",{action:"sendMessage",number:a.number,content:h.content,attachments:[]}).then(T=>{M(T?L=>[...L,h]:L=>[...L,{...h,delivered:!1}])})},he=()=>{F.PopUp.set({title:r("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:r("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:r("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:r("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{k("Maps",{action:"getCurrentLocation"}).then(s=>{if(!s)return;let h={id:a.id,sender:f,content:`<!SENT-LOCATION-X=${ve(s.x,2)}Y=${ve(s.y,2)}!>`,attachments:[],timestamp:Date.now()};k("Messages",{action:"sendMessage",number:a.number,content:h.content,attachments:h.attachments,id:h.id}).then(T=>{M(T?L=>[...L,h]:L=>[...L,{...h,delivered:!1}])})})}}]})},De=()=>{if(P||R)return;let s=document.querySelector("#last");if(!s)return;!$e(s)&&(p(!0),k("Messages",{action:"getMessages",page:J+1,id:a.id}).then(T=>{if(T&&T.length>0){let L=document.querySelector(".message-container");ue.current=L.scrollHeight,M([...T.reverse(),...v]),p(!1)}else O(!0)}),B(T=>T+1))};m.useEffect(()=>{let s=document.querySelector(".message-container");const h=s.scrollHeight;s.scrollTop+=h-ue.current,s.scroll},[v]),ee("messages:newMessage",s=>{a.id===s.id&&(C.airplaneMode||M(h=>[...h,{...s,timestamp:Date.now()}]))}),ee("messages:renameGroup",s=>{a.id===s.channelId&&(C.airplaneMode||i(h=>({...h,name:s.name})))}),ee("messages:messageDeleted",s=>{s&&(C.airplaneMode||M(v.filter(h=>h.id!==s)))}),ee("messages:removeMember",s=>{a.id===s.channelId&&(C.airplaneMode||s.number===f&&(u("userlist"),i(null)))});const Ue=be(s=>{let h=s.target;for(;!h.classList.contains("message");)h=h.parentElement;let T=h.getAttribute("data-id");if(!T)return;let L=v.find(z=>z.id===T);L&&L.sender===f&&(fe(L.content)||Le(L.content)||Pe(L.content)||F.ContextMenu.set({buttons:[{title:r("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{k("Messages",{action:"deleteMessage",id:T}).then(z=>{})}}]}))}),Le=s=>!s||!H.EnableMessagePay?!1:/<!SENT-PAYMENT-(\d*)!>/.test(s)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(s),fe=s=>{if(s)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(s)},Pe=s=>{if(s)return s==="<!CALL-NO-ANSWER!>"},ke=s=>{if(s)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(s)},ye=s=>{if(s)return!/^<!.*!>$/.test(s)};return e(ie,{children:o("div",{className:"animation-slide left",children:[o(me,{children:[g&&e(mt,{setShow:I,setShowUserInfo:G,sendLocation:he,setData:i,data:a}),S&&e(dt,{setShow:G,user:a!=null&&a.isGroup?S:a})]}),o("div",{className:"message-header",children:[o("div",{className:"back",onClick:()=>{u("userlist"),i(null),a.unread&&(k("Messages",{action:"markRead",id:a.id}),c(s=>s-1))},children:[e(Xe,{}),N>0&&e("span",{className:"back-title",children:N})]}),o("div",{className:"user",onClick:()=>{a.isGroup?I(!0):G(!0)},children:[a.isGroup?e("div",{className:"group-avatar",children:a.members.sort((s,h)=>s.avatar?1:-1).map((s,h)=>e("img",{src:s.avatar??"./assets/img/no-pfp.png",alt:""},h)).slice(0,5)}):e("img",{src:a.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:a.isGroup?a.name??`${a.members.length} ${r("APPS.MESSAGES.PEOPLE")}`:a.name??j(a.number)})]}),e(Be,{className:`facetime ${a.isGroup?"hidden":""}`,onClick:()=>{a.isGroup||Ve({number:a.number,videoCall:!0})}})]}),e("div",{className:"message-container",onScroll:De,style:V||D?{height:"48%"}:{},children:e("div",{className:"message-body",children:v.map((s,h)=>e(it,{index:h,messages:v,message:s,longPressEvent:Ue,func:{isMissed:Pe,isLocation:fe,isVoiceMessage:ke,pay:Ee}}))})}),e("div",{className:"attachments",children:Y.attachments.map((s,h)=>o("div",{className:"attachment",children:[Ce(s)?e("video",{src:s,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e("img",{src:s}),e(de,{onClick:()=>{ne({...Y,attachments:Y.attachments.filter((T,L)=>L!==h)})}})]},h))}),o("div",{className:"message-bottom",style:V||D?{height:"18%"}:{},children:[e("div",{className:"upper",children:o("div",{className:"input","data-border":!A,children:[A?o("div",{className:"audio-message",children:[e(de,{onClick:()=>U(null)}),e("div",{className:"audio-waves",children:e("img",{src:A.waves.placeholder})})]}):e(re,{placeholder:r("APPS.MESSAGES.PLACEHOLDER"),ref:ae,value:Y.content,onChange:s=>{ne({content:s.target.value,attachments:Y.attachments})},onKeyDown:s=>{s.key=="Enter"&&Se()}}),(Y.content.length>0||Y.attachments.length>0||A)&&e("div",{className:"send",onClick:Se,children:e(Ge,{})})]})}),e("div",{className:"actions-wrapper",children:o("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(d)return F.Emoji.reset();F.Emoji.set({onSelect:s=>ne(h=>({content:`${h.content}${s.emoji}`,attachments:h.attachments}))})},children:e("img",{src:"./assets/img/icons/messages/emoji.png"})}),e("div",{className:"action",onClick:()=>{var s,h,T;Y.attachments.length<3&&F.Gallery.set({includeVideos:!0,allowExternal:(T=(h=(s=te)==null?void 0:s.value)==null?void 0:h.AllowExternal)==null?void 0:T.Messages,onSelect:L=>ne({...Y,attachments:[...Y.attachments,L.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),(H==null?void 0:H.EnableMessagePay)&&!a.isGroup&&e("div",{className:"action black",onClick:()=>{_(!1),$(s=>!s)},children:"$"}),e("div",{className:"action",onClick:()=>he(),children:e(qe,{})}),(H==null?void 0:H.EnableVoiceMessages)&&e("div",{className:"action blue",onClick:()=>{$(!1),_(s=>!s)},children:e(we,{})})]})}),V&&e(ct,{paymentAmount:w,setPaymentAmount:b,pay:Ee,request:Ie}),D&&e(lt,{onEnd:s=>{s&&(U({src:URL.createObjectURL(s.blob),blob:s.blob,waves:s.waveform,duration:s.duration}),_(!1))}})]})]})})}const it=({messages:t,message:n,index:E,longPressEvent:C,func:f})=>{var V,$;const{User:a}=m.useContext(se),i=y(q.PhoneNumber),[l]=a,u=y(te);let N,c,d,g,I,S,G=E===0?"last":"",D=n.sender===i?"self":"other",_=((V=t[E+1])==null?void 0:V.sender)===i?"self":"other";if(t[E+1]?d=Math.abs(n.timestamp-t[E+1].timestamp)/36e5:_=void 0,l.isGroup)N=($=l.members.find(w=>w.number===n.sender))==null?void 0:$.name,c=!t[E-1]||t[E-1].sender!==n.sender;else if(N=l.name,n.content)if(f.isMissed(n.content))if(D==="other")n.content=r("APPS.MESSAGES.MISSED_CALL").format({number:n.sender});else return null;else/<!SENT-PAYMENT-(\d*)!>/.test(n.content)?g={amount:n.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(n.content)&&(g={amount:n.content.match(/\d/g).join(""),request:!0});if(f.isLocation(n.content)){let w=n.content.match(/X=(-?\d*\.?\d*)Y/)[1],b=n.content.match(/Y=(-?\d*\.?\d*)!>/)[1];I={x:w,y:b}}return f.isVoiceMessage(n.content)&&(S={wave:n.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:n.content.match(/AUDIO="([^"]+)"/)[1],duration:n.content.match(/DURATION="([^"]+)"/)[1]}),o("div",{className:`message ${D}`,id:G,"data-id":n.id,...C,children:[c&&D=="other"&&e("div",{className:"user",children:N??j(n.sender)}),n.delivered===!1?o("div",{className:"content-wrapper",children:[g&&e("div",{className:"payment",children:u.CurrencyFormat.replace("%s",g.amount)}),!g&&e("div",{className:"content",children:ge(n.content)}),e(Qe,{})]}):g||I||S?o(ie,{children:[I&&o("div",{className:"location",onClick:()=>{q.App.set({name:"Maps",data:{location:[I.y,I.x],name:`${N??j(n.sender)}'s location`,icon:l.avatar}})},children:[e("div",{className:"img",style:{backgroundImage:'url("https://img.gta5-mods.com/q95/images/mirror-park-garden/2b72f9-20160428154103_1.jpg")'}}),D==="other"&&o("div",{className:"sender",children:[N??j(n.sender)," ",r("APPS.MESSAGES.SENT_LOCATION")]})]}),g&&e("div",{className:"payment",children:g.request?o("div",{className:`request ${D}`,children:[o("div",{className:"title",children:[u.CurrencyFormat.replace("%s",Me(g.amount))," ",r("APPS.MESSAGES.PAY.REQUESTED")]}),D==="other"&&e("div",{className:"button",onClick:()=>f.pay(g.amount),children:r("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:u.CurrencyFormat.replace("%s",Me(g.amount))})}),S&&e(ot,{data:S,sender:D})]}):n.content&&e("div",{className:"content",children:ge(n.content)}),n.attachments&&n.attachments.length>0&&e("div",{className:"attatchments",children:n.attachments.map((w,b)=>Ce(w)?e("video",{src:w,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:J=>F.FullscreenImage.set({display:!0,image:w})},b):e(Fe,{src:w,onClick:()=>F.FullscreenImage.set({display:!0,image:w})},b))}),n.delivered===!1?e("div",{className:"status",children:r("APPS.MESSAGES.NOT_DELIVERED")}):t[E+1]&&d>6?e("div",{className:"date",children:Ne(n.timestamp)}):D!==_&&e("div",{className:"date",children:Ne(n.timestamp)})]},E)},lt=({onEnd:t})=>{const n=y(te),[E,C]=m.useState(!1),f=m.useRef(null);return n.EnableVoiceMessages?(m.useEffect(()=>{f.current=new nt},[]),ee("camera:toggleMicrophone",a=>{f!=null&&f.current&&(a?f.current.unmute():f.current.mute())}),e("div",{className:"audioMessage-container",children:e("div",{className:"audioMessage-button","data-recording":E,onClick:()=>{var i;if(!((i=navigator.mediaDevices)!=null&&i.getUserMedia)||!(f!=null&&f.current))return X("error","No media devices found!");let a=f.current;E?a.stop().then(l=>{t(l),C(u=>!u)}):navigator.mediaDevices.getUserMedia({audio:!0}).then(l=>{X("info","Message: Got audio stream"),a.start(l),C(u=>!u)})},children:E?e(de,{}):e(we,{})})})):null},ct=({paymentAmount:t,setPaymentAmount:n,request:E,pay:C})=>{const f=y(te),[a,i]=m.useState(0),[l,u]=m.useState(4);let N={0:3,11:2.75,14:2.2};return m.useEffect(()=>{a===0&&u(N[0]);let c=0;for(let d=0;d<Object.keys(N).length;d++)a>=parseInt(Object.keys(N)[d])&&(c=N[Object.keys(N)[d]]);u(c)},[a]),m.useEffect(()=>{n(a)},[a]),o("div",{className:"payment-container",children:[o("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&i(c=>c-1),children:"-"}),e("div",{className:"amount",children:e(re,{type:"number",value:t,style:{fontSize:`${l}rem`},onChange:c=>{if(c.target.value.match(/^[0-9]+$/)&&parseFloat(c.target.value)>0&&parseFloat(c.target.value)<(f.MaxTransferAmount??Number.MAX_SAFE_INTEGER))i(parseFloat(c.target.value));else return c.preventDefault()}})}),e("div",{className:"button",onClick:()=>i(c=>c+1),children:"+"})]}),o("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>E(t),children:r("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>C(t),children:r("APPS.MESSAGES.PAY.SEND")})]})]})},ot=({data:t,sender:n})=>{var u;const[E,C]=m.useState(!1),[f,a]=m.useState(0),i=m.useRef(null);m.useEffect(()=>{i.current&&(i.current.onended=()=>{C(!1)})},[i]);const l=N=>{N=Math.floor(N);const c=Math.floor(N/60),d=N-c*60;return`${c<10?"0"+c:c}:${d<10?"0"+d:d}`};return o("div",{className:`voice-message ${n}`,children:[e("a",{onClick:()=>{i.current&&(E?(i.current.pause(),i.current.currentTime=0):i.current.play(),C(N=>!N))},children:E?e(We,{}):e(ze,{})}),o("div",{className:"wave",children:[e("div",{className:"overlay",style:{width:`${(t.duration-f)/t.duration*100}%`}}),e("img",{src:t.wave,alt:"wave"})]}),e("div",{className:"duration",children:l(E&&Math.floor(((u=i.current)==null?void 0:u.currentTime)+.5)!==0?i.current.currentTime:t.duration)}),e("audio",{ref:i,onTimeUpdate:N=>a(N.currentTarget.currentTime),children:e("source",{src:t.src,type:"audio/mpeg"})})]})},dt=({user:t,setShow:n})=>o(ce.div,{...le,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>n(!1),children:r("APPS.MESSAGES.DONE")})}),o("div",{className:"info-panel-body",children:[o("div",{className:"info-panel-top",children:[t.avatar?e("div",{className:"profile-image bigger",style:{backgroundImage:`url(${t.avatar})`}}):t.name?e("div",{className:"profile-image bigger",children:Ye(t.name)}):e("img",{src:t.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:t.name??j(t.number)})]}),e("div",{className:"items",children:!t.company&&o(ie,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>je(t.number),children:j(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{F.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:r("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{q.App.set({name:"Phone",view:"newContact",data:t.number})},children:r("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]}),mt=t=>{const{View:n}=m.useContext(se),[E,C]=n,[f,a]=m.useState(!1),[i,l]=m.useState(null);let u=t.data,N=!u.members.find(c=>c.isOwner);return o(ie,{children:[e(me,{children:f&&e(ut,{setShow:a,members:u.members,id:u.id})}),o(ce.div,{...le,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>{i&&i!==""&&i!==u.name?k("Messages",{action:"renameGroup",id:u.id,name:i}).then(c=>{t.setShow(!1)}):t.setShow(!1)},children:r("APPS.MESSAGES.DONE")})}),o("div",{className:"info-panel-body",children:[o("div",{className:"info-panel-top",children:[e("div",{className:"group-avatar",children:u.members.sort((c,d)=>c.avatar?1:-1).slice(0,10).map((c,d)=>e("img",{src:c.avatar??"./assets/img/no-pfp.png",alt:""},d))}),o("div",{className:"members",children:[u.members.length," ",r("APPS.MESSAGES.MEMBERS")]})]}),o("div",{className:"items",children:[e("div",{className:"info-section",children:o("div",{className:"item blue",children:[e(Ke,{className:"add"}),e(re,{defaultValue:u.name??"Group Name",onChange:c=>l(c.target.value)})]})}),o("div",{className:"info-section",children:[u.members.sort((c,d)=>c.name&&!d.name?-1:!c.name&&d.name?1:c.name<d.name?-1:c.name>d.name?1:0).map((c,d)=>o("div",{className:"item",children:[N&&e(Je,{className:"remove",onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:r("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:c.name??j(c.number)}),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{k("Messages",{action:"removeMember",number:c.number,id:u.id}).then(g=>{g&&(t.setData(I=>{let S=I;return S.members=S.members.filter(G=>G.number!==c.number),S}),t.setShow(!1))})}}]})}}),e("img",{src:c.avatar??"./assets/img/no-pfp.png",alt:""}),e("div",{className:"name",children:c.name??j(c.number)}),e(Ze,{className:"info",onClick:()=>{t.setShowUserInfo({...c})}})]},d)),o("div",{className:"item blue",onClick:()=>a(!0),children:[e(et,{className:"add"}),r("APPS.MESSAGES.ADD_MEMBER")]})]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:r("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:r("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{k("Messages",{action:"leaveGroup",id:u.id}).then(c=>{if(!c)return X("info","Failed to leave group, server didnt callback request");C("userlist"),t.setShow(!1)})}}]})},children:e("div",{className:"item red",children:r("APPS.MESSAGES.LEAVE_GROUP")})})]})]})]})]})},ut=t=>{const n=y(q.PhoneNumber),[E,C]=m.useState(""),f=y(x.APPS.PHONE.contacts);let a=t.members;return o(ce.div,{...le,className:"add-member-container",children:[o("div",{className:"add-member-header",children:[o("div",{className:"top",children:[e("span",{}),e("div",{className:"title",children:r("APPS.MESSAGES.ADD_MEMBER")}),e("div",{className:"button",onClick:()=>t.setShow(!1),children:r("APPS.MESSAGES.CANCEL")})]}),e(Te,{placeholder:r("APPS.MESSAGES.SEARCH"),onChange:i=>C(i.target.value)})]}),e("div",{className:"contacts",children:f.filter(i=>!i.company).sort((i,l)=>i.firstname&&!l.firstname?-1:!i.firstname&&l.firstname?1:i.firstname<l.firstname?-1:i.firstname>l.firstname?1:0).filter(i=>!a.find(l=>l.number===i.number)||i.number===n).filter(i=>{var l,u;return i.firstname.toLowerCase().includes(E.toLowerCase())||((u=(l=i==null?void 0:i.lastname)==null?void 0:l.toLowerCase())==null?void 0:u.includes(E.toLowerCase()))}).map((i,l)=>{let u=K(i.firstname,i.lastname);return o("div",{className:"contact",onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.ADD_POPUP.TITLE"),description:r("APPS.MESSAGES.ADD_POPUP.TEXT").format({name:u}),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.ADD_POPUP.ADD"),cb:()=>{k("Messages",{action:"addMember",number:i.number,id:t.id}).then(N=>{N&&t.setShow(!1)})}}]})},children:[e("img",{src:i.avatar??"./assets/img/no-pfp.png"}),o("div",{className:"user",children:[e("div",{className:"name",children:u}),e("div",{className:"number",children:j(i.number)})]})]},l)})})]})};function St(){const{User:t,View:n,Newmessage:E,ImportedUser:C}=m.useContext(se),[f,a]=t,[i,l]=n,[u,N]=C,c=y(q.PhoneNumber),[d,g]=E,I=y(x.APPS.PHONE.contacts),[S,G]=m.useState([]),D=m.useRef(null),[_,V]=m.useState(""),[$,w]=m.useState([]),[b,J]=m.useState({content:"",attachments:[]});m.useEffect(()=>{u&&(G([u]),N(null))},[u]);const B=()=>{(b.content.length>0||b.attachments.length>0)&&(S.length>1?k("Messages",{action:"createGroup",members:S,content:b.content,attachments:b.attachments}).then(P=>{P&&(a({isGroup:!0,members:S.map(O=>{let R=K(O.firstname,O.lastname);return{...O,name:R}}),lastMessage:b.content,timestamp:Date.now(),id:P}),l("messages"),g(!1))}):k("Messages",{action:"sendMessage",number:S[0].number,content:b.content,attachments:b.attachments}).then(P=>{var O,R,p,v;if(P){let M;S[0].name?M=S[0].name:(O=S[0])!=null&&O.firstname&&(M=K((R=S[0])==null?void 0:R.firstname,(p=S[0])==null?void 0:p.lastname));let A={number:S[0].number,name:M,avatar:(v=S[0])==null?void 0:v.avatar};a({...A,lastMessage:b.content,timestamp:Date.now(),id:P}),l("messages"),g(!1)}}))};return m.useEffect(()=>{if(_.length>0){if(I){const P=I.filter(O=>{let R=K(O.firstname,O.lastname);return R&&R.toLowerCase().includes(_.toLowerCase())&&!O.company});w(P)}}else w([])},[_]),o(ce.div,{...le,className:"new-message-container",children:[o("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:r("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{S.length>0&&(b.content.length>0||b.attachments.length>0)?B():g(!1)},children:S.length>0&&(b.content.length>0||b.attachments.length>0)?r("APPS.MESSAGES.SEND"):r("APPS.MESSAGES.CANCEL")})]}),o("div",{className:"new-message-body",children:[o("div",{className:"new-message-search",children:[o("div",{className:"to",children:[r("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:S.map((P,O)=>{let R=K(P.firstname,P.lastname),p=R!=="Unknown";return e("div",{className:`contact ${p?"green":"blue"}`,onClick:()=>{F.PopUp.set({title:r("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:r("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:R??j(P.number)}),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let v=S.filter(M=>M.number!==P.number);G(v)}}]})},children:p?R:j(P.number)},O)})}),e(re,{type:"text",ref:D,onChange:P=>{if(V(P.target.value),P.target.value.length==c.length&&/^\d+$/g.test(P.target.value)){if(P.target.value===c||S.find(R=>R.number==P.target.value))return;G([...S,{number:P.target.value}]),D.current.value="",V("")}},onKeyDown:P=>{var O;P.key=="Backspace"&&_.length==0?((O=S[S.length-1])==null?void 0:O.name)===void 0?(D.current.value=S[S.length-1].number,G(S.slice(0,S.length-1))):G(S.slice(0,-1)):P.key=="Tab"&&(P.preventDefault(),$.length==1&&(G([...S,$[0]]),D.current.value="",V("")))}})]}),e("div",{className:"search-results",children:$&&$.filter(P=>!S.find(O=>O.number==P.number)).map((P,O)=>{let R=K(P.firstname,P.lastname);return o("div",{className:"contact",onClick:()=>{S.find(v=>v.number==P.number)||(G([...S,P]),D.current.value="",V(""))},children:[e("img",{src:P.avatar??"./assets/img/no-pfp.png"}),o("div",{className:"user",children:[e("div",{className:"name",children:R}),e("div",{className:"number",children:j(P.number)})]})]},O)})})]}),S.length>0&&$.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:o("div",{className:"input",children:[e(re,{placeholder:r("APPS.MESSAGES.PLACEHOLDER"),value:b.content,onChange:P=>{J({content:P.target.value??"",attachments:b.attachments})},onKeyDown:P=>{P.key=="Enter"&&B()}}),(b.content.length>0||b.attachments.length>0)&&e("div",{className:"send",onClick:()=>B(),children:e(Ge,{})})]})})})]})}const W=Oe([]),Q=Oe([]);function Et(){const{User:t,View:n,Newmessage:E,UnreadMessages:C,ImportedUser:f}=m.useContext(se),a=y(q.PhoneNumber),i=y(q.Settings),l=y(q.App),[u,N]=t,[c,d]=n,[g,I]=f,[S,G]=E,[D,_]=C,V=y(x.APPS.PHONE.contacts),$=y(x.APPS.MESSAGES.messages),w=y(W),[b,J]=m.useState(""),[B,P]=m.useState(!1),O=y(Q);m.useEffect(()=>{$?(X("info","Using cache for recent messages"),W.set($),_(w.filter(p=>p.unread).length)):k("Messages",{action:"getRecentMessages"}).then(p=>{let v=p.map(M=>{if(M.isGroup)return M.members=M.members.filter(A=>A.number!==a).map(A=>{let U=V.find(ae=>ae.number===A.number);return{name:U&&U.firstname?K(U==null?void 0:U.firstname,U==null?void 0:U.lastname):void 0,avatar:U==null?void 0:U.avatar,blocked:U==null?void 0:U.blocked,favourite:U==null?void 0:U.favourite,number:A.number,isOwner:A.isOwner}}),M;{let A=V.find(U=>U.number===M.number);return M.name=A!=null&&A.lastname?`${A.firstname} ${A.lastname}`:A==null?void 0:A.firstname,M.avatar=A==null?void 0:A.avatar,M}});_(v.filter(M=>M.unread).length),W.set(v),X("info","setting cache"),x.APPS.MESSAGES.messages.set(v)})},[$]);let R=m.useRef(!1);return m.useEffect(()=>{if(!R.current&&l!=null&&l.data&&(R.current=!0,l!=null&&l.data&&l.view=="messages")){let p=w.find(v=>v.number===l.data.number);p?(N(p),d("messages")):(G(!0),I({number:l.data.number,name:l.data.name,avatar:l.data.avatar})),q.App.set({name:l.name})}},[l==null?void 0:l.data,w]),ee("messages:newMessage",p=>{let v=JSON.parse(JSON.stringify(w)),M=v.findIndex(A=>A.id===p.id);i.airplaneMode||(M!==-1&&v.unshift(v.splice(M,1)[0]),v[0].lastMessage=p.content,v[0].timestamp=new Date,W.set(v))}),o(ie,{children:[e(me,{children:S&&e(St,{})}),o("div",{className:`animation-slide ${w.length>0?"right":""}`,children:[o("div",{className:"messages-header",children:[o("div",{className:"buttons",children:[e("div",{className:"edit",onClick:()=>P(!B),children:B?r("APPS.MESSAGES.DONE"):r("APPS.MESSAGES.EDIT")}),e(tt,{"data-disabled":B,onClick:()=>G(!0)})]}),e("div",{className:"title",children:r("APPS.MESSAGES.TITLE")})]}),e(Te,{placeholder:r("SEARCH"),onChange:p=>J(p.target.value)}),e("div",{className:"users-list",children:w.filter(p=>{var v;return p.deleted?!1:(p.isGroup?p.members.find(M=>{var A;return((A=M.name)==null?void 0:A.toLowerCase().includes(b.toLowerCase()))||M.number.includes(b)}):((v=p.name)==null?void 0:v.toLowerCase().includes(b.toLowerCase()))||p.number.includes(b))||p.lastMessage.toLowerCase().includes(b.toLowerCase())}).sort((p,v)=>v.timestamp-p.timestamp).map((p,v)=>e(ht,{user:p,editMode:B,onClick:()=>{if(N(p),d("messages"),p.unread){k("Messages",{action:"markRead",id:p.id}),_(A=>A-1);let M=x.APPS.MESSAGES.messages.value;x.APPS.MESSAGES.messages.set(M.map(A=>(A.id===p.id&&(A.unread=!1),A)))}}},v))}),B&&o("div",{className:"messages-footer",children:[e("div",{className:"button","data-disabled":!0,children:r("APPS.MESSAGES.READ")}),e("div",{className:"button",onClick:()=>{if(O.length===0)return X("info","No messages selected, can't delete");F.PopUp.set({title:r("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:r("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.DELETE"),cb:()=>{k("Messages",{action:"deleteConversations",channels:O}).then(p=>{if(!p)return X("error","Failed to delete conversations");P(!1),W.set(w.filter(v=>!O.includes(v.id))),x.APPS.MESSAGES.messages.set([...x.APPS.MESSAGES.messages.value.map(v=>(O.includes(v.id)&&(v.deleted=!0),v))]),Q.set([])})}}]})},children:r("APPS.MESSAGES.DELETE")})]})]})]})}const ht=({user:t,editMode:n,onClick:E})=>{var N,c;const C=y(te),f=y(W);y(Q);const[a,i]=m.useState(!1);let l;const u=be(d=>{F.ContextMenu.set({buttons:[{title:r("APPS.MESSAGES.MARK_AS_READ"),cb:()=>{k("Messages",{action:"markRead",id:t.id}).then(g=>{if(!g)return X("error","Failed to mark message as read");W.set(f.map(S=>(S.id===t.id&&(S.unread=!1),S)));let I=x.APPS.MESSAGES.messages.value;x.APPS.MESSAGES.messages.set(I.map(S=>(S.id===t.id&&(S.unread=!1),S)))})}},{title:r("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),color:"red",cb:()=>{F.PopUp.set({title:r("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:r("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:r("APPS.MESSAGES.CANCEL")},{title:r("APPS.MESSAGES.DELETE"),cb:()=>{k("Messages",{action:"deleteConversations",channels:[t.id]}).then(g=>{if(!g)return X("error","Failed to delete conversations");W.set(f.filter(I=>I.id!==t.id)),x.APPS.MESSAGES.messages.set([...x.APPS.MESSAGES.messages.value.map(I=>(I.id===t.id&&(I.deleted=!0),I))]),Q.set([])})}}]})}}]})});if(t.isGroup?t.name?l=t.name:l=t.members.sort((d,g)=>d.name&&!g.name?-1:!d.name&&g.name?1:d.name<g.name?-1:d.name>g.name?1:0).map((d,g)=>{if(g<2)return d.name?d.name:j(d.number);if(g===2)return`+${t.members.length-2} ${r("APPS.MESSAGES.OTHER").toLowerCase()}`}).join(" "):l=t.name,t.lastMessage){if(t.lastMessage==="Attachment"&&(t.lastMessage=r("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let d=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${r("APPS.MESSAGES.SENT")} ${C.CurrencyFormat.replace("%s",d)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let d=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${r("APPS.MESSAGES.REQUESTED")} $${d}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${r("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage=r("APPS.MESSAGES.SENT_AUDIO_MESSAGE");else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=r("APPS.MESSAGES.TRIED_TO_CALL").format({number:j(t.number)});else if(t.lastMessage==="")return}return m.useEffect(()=>{a?Q.set([...Q.value,t.id]):Q.set(Q.value.filter(d=>d!==t.id))},[a]),o("div",{className:"user",...u,onClick:()=>{n?i(!a):E()},children:[o("div",{className:"items",children:[n&&e("div",{className:"check","data-checked":a,onClick:d=>{d.stopPropagation(),i(!a)},children:a&&e(st,{})}),e("div",{className:xe("dot",t.unread&&"unread")})]}),t.isGroup?e("div",{className:"avatar group",children:t.members.map((d,g)=>{if(g<=3)return d.avatar?e("div",{style:{backgroundImage:`url(${d.avatar})`}},g):d.name?e("div",{children:d.name.charAt(0)},g):e("div",{className:"unknown"},g)})}):e("img",{className:"avatar",src:t.avatar??"assets/img/no-pfp.png"}),o("div",{className:"user-body",children:[o("div",{className:"user-header",children:[e("div",{className:"name",children:l??j(t.number)}),o("div",{className:"right",children:[e("div",{className:"time",children:He(t.timestamp)}),e(at,{})]})]}),e("div",{className:"content",children:((N=t.lastMessage)==null?void 0:N.length)>40?((c=t.lastMessage)==null?void 0:c.substring(0,40))+"...":t.lastMessage})]})]})};const se=m.createContext(null);function vt(){const[t,n]=m.useState(null),[E,C]=m.useState("userlist"),[f,a]=m.useState(null),[i,l]=m.useState(0),[u,N]=m.useState(!1);return e("div",{className:"messages-container",children:e(se.Provider,{value:{User:[t,n],View:[E,C],Newmessage:[u,N],ImportedUser:[f,a],UnreadMessages:[i,l]},children:E=="userlist"?e(Et,{}):e(rt,{})})})}export{se as MessagesContext,vt as default};
