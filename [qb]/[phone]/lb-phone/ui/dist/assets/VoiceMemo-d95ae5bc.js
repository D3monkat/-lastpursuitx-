import{r as c,a as h,j as o,F as U}from"./jsx-runtime-f40812bf.js";import{d as u,f as O,n as S,u as _,C as D,L as E,g as V,Q as F,x as H,o as j,O as R,I as L,A as k,b as B}from"./Phone-d66a2975.js";import{r as G}from"./number-28525126.js";import{u as T,s as K,P as W,m as Q,ax as q,F as z,G as J,a as X,H as Y,ad as Z}from"./index.esm-9527ffc7.js";const $=K(null);function ie(){const P=c.useRef(null),[i,N]=c.useState(""),[I,r]=c.useState(!1),m=T(S.APPS.VOICEMEMO.voicememos);c.useEffect(()=>{var t;return(t=navigator.mediaDevices)==null||t.getUserMedia({audio:!0}).then(a=>{P.current=a,u("info","VoiceMemo: Got audio stream"),O("isTalking").then(A)}),S.APPS.DARKCHAT.channels.value||O("VoiceMemo",{action:"get"}).then(a=>{S.APPS.VOICEMEMO.voicememos.set(a)}),()=>{P.current&&P.current.getTracks().forEach(a=>a.stop())}},[]);const A=t=>{if(!P.current)return u("warning","No audio stream");u("info",`Toggling microphone ${t?"on":"off"}`),P.current.getAudioTracks()[0].enabled=t};_("camera:toggleMicrophone",t=>{A(t)});const y=(t,a)=>{var b,C;const n=(b=V.value)!=null&&b.ice?new R({config:{iceTransportPolicy:"relay",iceServers:(C=V.value)==null?void 0:C.ice}}):new R;n.on("open",s=>{O("Camera",{action:"setRecordingPeerId",peerId:s}),u("info","Listening for nearby voices")});const l=document.createElement("canvas");l.width=1,l.height=1;const d=l.captureStream(0);return n.on("call",s=>{s.answer(d),s.on("stream",f=>{u("info","Received nearby voice");const v=new Audio;v.srcObject=f,v.volume=0,v.play(),new MediaStreamAudioSourceNode(t,{mediaStream:f}).connect(a)}),s.on("close",()=>{u("info","Stopped receiving nearby voice")})}),n},M=()=>{let t=E("APPS.VOICEMEMO.DEFAULT_NAME"),a=m.map(n=>{let l=n.title;if(l.startsWith(t)){let d=l.split(" ");if(d.length>1&&/^\d+$/.test(d[d.length-1]))return parseInt(d[d.length-1])}return null}).filter(n=>n!==null).sort((n,l)=>n-l);if(a.length===0)return m.some(n=>n.title===t)?`${t} 2`:t;for(let n=0;n<a.length;n++)if(a[n]!==n+2)return`${t} ${n+2}`;return`${t} ${a[a.length-1]+1}`};return c.useEffect(()=>{var s;if(!I)return;if(!P.current)return D.PopUp.set({title:E("APPS.VOICEMEMO.NO_MICROPHONE_POPUP.TITLE"),description:E("APPS.VOICEMEMO.NO_MICROPHONE_POPUP.DESCRIPTION"),buttons:[{title:E("APPS.VOICEMEMO.NO_MICROPHONE_POPUP.OK")}]}),r(!1);const t=new AudioContext,a=new MediaStreamAudioDestinationNode(t);t.createMediaStreamSource(P.current).connect(a),O("isTalking").then(f=>{A(f)});let l;(s=V.value)!=null&&s.recordNearbyVoices&&(l=y(t,a));const d=new MediaRecorder(a.stream);let b=[],C=Date.now();return d.ondataavailable=f=>{b.push(f.data)},d.onstop=async()=>{let f=Date.now()-C,v=Math.round(f/1e3);const e=new Blob(b,{type:d.mimeType});l&&(l.destroy(),u("info","Destroyed peer connection"),O("Camera",{action:"endedRecording"})),t.close();const g=await F(e,f,{logger:!1});H("Audio",g).then(p=>{u("info","Uploaded media");let x=M();O("VoiceMemo",{action:"upload",data:{src:p,duration:v,title:x}}).then(w=>{if(!w)return u("warning","Failed to upload voice memo");S.APPS.VOICEMEMO.voicememos.set([{id:w,title:x,timestamp:new Date().getTime(),duration:v,src:p},...m]),u("info",`Saved voice memo ${w}`)})}).catch(p=>{u("error","Failed to upload ",p)})},d.start(),()=>{d.stop()}},[I]),h("div",{className:"voicememo-container",children:[h("div",{className:"voicememo-wrapper",children:[o("div",{className:"title",children:E("APPS.VOICEMEMO.ALL_RECORDINGS")}),o(j,{placeholder:E("SEARCH"),theme:"dark",onChange:t=>N(t.target.value)}),o("div",{className:"voicememo-items",children:m.filter(t=>t.title.toLowerCase().includes(i.toLowerCase())).sort((t,a)=>a.timestamp-t.timestamp).map(t=>o(ee,{data:t,delete:()=>S.APPS.VOICEMEMO.voicememos.set(m.filter(a=>a.id!==t.id))},t.id))})]}),o("div",{className:"voicememo-footer",children:o("div",{className:"button-record",onClick:()=>r(!I),children:o("div",{className:"button-inner","data-recording":I})})})]})}const ee=P=>{const{data:i}=P,N=T(B.Settings),I=T(S.APPS.VOICEMEMO.voicememos),r=c.useRef(null),[m,A]=c.useState(!1),[y,M]=c.useState(!1),[t,a]=c.useState(0),n=T($),[l,d]=c.useState(i.title),[b,C]=c.useState(!1),[s,f]=c.useState(null);c.useEffect(()=>(r.current=new Audio(i.src),r.current.src=i.src,r.current.volume=N.sound.volume??.5,r.current.addEventListener("ended",()=>{M(!1)}),r.current.addEventListener("timeupdate",()=>{a(r.current.currentTime)}),()=>{var e,g;(e=r.current)==null||e.pause(),(g=r.current)==null||g.remove(),r.current=null}),[]),c.useEffect(()=>{var e;n&&n!==i.id&&((e=r.current)==null||e.pause(),M(!1),A(!1))},[n]),c.useEffect(()=>{N.sound.volume&&(r.current.volume=N.sound.volume)},[N.sound.volume]),c.useEffect(()=>{M(!1),a(0),m&&$.set(i.id)},[m]);const v=e=>{const g=Math.floor(e/60),p=G(e-g*60,0);return`${g}:${p<10?"0"+p:p}`};return h("div",{className:"voicememo-item",onClick:()=>A(!m),"data-expanded":m,children:[m?o(L,{className:"voicememo-title",defaultValue:l,onClick:e=>e.stopPropagation(),onLoad:e=>{e.target.style.width=e.target.value.length+"ch"},onChange:e=>{d(e.target.value),e.target.style.width=e.target.value.length+"ch"},onBlur:e=>{O("VoiceMemo",{action:"rename",id:i.id,title:e.target.value}).then(g=>{if(!g)return u("warning","Failed to rename voice memo");S.APPS.VOICEMEMO.voicememos.set(I.map(p=>p.id===i.id?{...p,title:e.target.value}:p))})}}):o("div",{className:"voicememo-title",children:l}),m&&o("div",{className:"subtitle",children:k(i.timestamp)}),h("div",{className:"voicememo-info",children:[!m&&h(U,{children:[o("div",{className:"date",children:k(i.timestamp)}),o("div",{className:"duration",children:v(i.duration)})]}),o(W,{children:m&&h(Q.div,{className:"voicememo-actions",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},children:[h("div",{className:"voicememo-duration-slider",onClick:e=>e.stopPropagation(),children:[o(L,{type:"range",min:0,max:100,value:s||t/i.duration*100,style:{background:`linear-gradient(to right, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.7) ${s||t/i.duration*100}%, rgba(255, 255, 255, 0.1) ${s||t/i.duration*100}%, rgba(255, 255, 255, 0.1) 100%)`},onMouseDown:e=>{e.stopPropagation(),C(!0)},onMouseUp:e=>{if(e.stopPropagation(),C(!1),s){if(!r.current)return u("warning","Audio ref is null");r.current.currentTime=i.duration/100*s,f(null)}},onChange:e=>{e.stopPropagation(),f(e.target.value)}}),h("div",{className:"duration",children:[o("div",{children:v(t)??"0:00"}),o("div",{children:v(i.duration)})]})]}),h("div",{className:"voicememo-item-footer",children:[o("div",{className:"share",children:o(q,{onClick:e=>{e.stopPropagation(),D.Share.set({type:"voicememo",data:i})}})}),h("div",{className:"controls",children:[o(z,{className:"disabled"}),o("span",{onClick:e=>{if(e.stopPropagation(),!r.current)return u("warning","Audio ref is null");y?(r.current.pause(),M(!1)):(r.current.play(),M(!0))},children:y?o(J,{}):o(X,{})}),o(Y,{className:"disabled"})]}),o("div",{className:"delete",children:o(Z,{onClick:e=>{e.stopPropagation(),D.PopUp.set({title:E("APPS.VOICEMEMO.DELETE_POPUP.TITLE"),description:E("APPS.VOICEMEMO.DELETE_POPUP.DESCRIPTION"),buttons:[{title:E("APPS.VOICEMEMO.DELETE_POPUP.CANCEL")},{title:E("APPS.VOICEMEMO.DELETE_POPUP.PROCEED"),color:"red",cb:()=>{O("VoiceMemo",{action:"delete",id:i.id}).then(g=>{if(!g)return u("warning","Failed to delete voice memo");P.delete()})}}]})}})})]})]})})]})]})};export{ie as default};
