import{r as n,j as s,F as _,a as b}from"./jsx-runtime-f40812bf.js";import{r as he,N as pe,d,f as o,u as ee,S as P,n as O,O as te,Q as ve,b as D,C as T,R as be,L as ae,w as Se,x as ye,U as Ce,g as we}from"./Phone-d66a2975.js";import{u as I,L as Pe,M as Ie,N as Ae}from"./index.esm-9527ffc7.js";import{r as re}from"./number-28525126.js";function xe(){const f=I(we),{Placement:ne}=n.useContext(he),se=I(T.CameraComponent),M=I(P.Unlocked),j=I(P.PassedFaceId),V=I(P.Visible),oe=I(P.LockScreenVisible),[Re,A]=ne.PhoneRotation,[$,S]=n.useState(!1),[c,E]=n.useState("Photo"),[L,H]=n.useState(!1),[ie,G]=n.useState(!1),[ce,x]=n.useState(!1),[R,X]=n.useState(!1),[u,le]=n.useState(!1),[W,Q]=n.useState(0),[de,B]=n.useState({}),U=n.useRef(null),z=n.useRef(null),y=n.useRef(null),l=n.useRef(null),m=n.useRef(null),g=["Video","Photo","Landscape"];n.useEffect(()=>{if(!y.current||l.current)return;let e=new pe(y.current);l.current=e},[y.current,V]),n.useEffect(()=>{var e;return(e=navigator.mediaDevices)==null||e.getUserMedia({audio:!0}).then(t=>{d("info","Camera: Got audio stream"),m.current=t}),()=>{l.current&&l.current.destroy(),m.current&&m.current.getTracks().forEach(t=>t.stop()),se||o("Camera",{action:"close"})}},[]),ee("camera:usedCommand",e=>{switch(e){case"toggleTaking":k();break;case"toggleFlip":X(t=>!t);break;case"toggleFlash":H(t=>!t);break;case"leftMode":if(u)return;E(t=>{const a=g.indexOf(t);return a===0?g[g.length-1]:g[a-1]});break;case"rightMode":if(u)return;E(t=>{const a=g.indexOf(t);return a===g.length-1?g[0]:g[a+1]});break}}),n.useEffect(()=>{if(!z.current)return;let e=[];const a=setInterval(()=>{e.length>2&&(e=[]),e.push("."),z.current.innerText=ae("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(a)},[$]);const F=(e,t)=>{if(t===void 0&&(t=Se(e)),t){const a=document.createElement("video");a.src=e,a.muted=!0,a.play();const r=document.createElement("canvas");if(!r)return;a.addEventListener("loadeddata",()=>{r.width=a.videoWidth,r.height=a.videoHeight,r.getContext("2d").drawImage(a,0,0,r.width,r.height);const p=r.toDataURL("image/png");U.current.style.backgroundImage=`url(${p})`,O.APPS.CAMERA.lastImage.set(p),r.remove(),a.remove()})}else U.current.style.backgroundImage=`url(${e})`,O.APPS.CAMERA.lastImage.set(e)};n.useEffect(()=>{if(o("Camera",{action:V?"open":"close"}),oe||!M)P.Flashlight&&(o("toggleFlashlight",{toggled:!1}),P.Flashlight.set(!1)),A(0),E("Photo");else{if(o("Camera",{action:"flipCamera",value:R}),O.APPS.CAMERA.lastImage.value)return F(O.APPS.CAMERA.lastImage.value);o("Camera",{action:"getLastImage"}).then(e=>{e&&F(e)})}},[M,j,V]),n.useEffect(()=>{if(u)return;switch(c){case"Landscape":B({marginRight:"9rem"}),A(90);break;case"Video":A(0),B({marginLeft:"12rem"});break;default:A(0),B({marginLeft:"3rem"});break}c==="Landscape"?l.current&&l.current.resizeByAspect(16/9):(c==="Video"||c==="Photo")&&l.current&&l.current.resizeByAspect(3/4),o("Camera",{action:"toggleLandscape",toggled:c==="Landscape"}),o("Camera",{action:"toggleVideo",toggled:c==="Video"});const e=window.innerWidth;e>1920&&l.current.setQuality(1920/e),c==="Photo"&&R?l.current.setXOffset(-.2):l.current.setXOffset(0)},[c]),n.useEffect(()=>{o("Camera",{action:"flipCamera",value:R}),!u&&(c=="Photo"&&R?l.current.setXOffset(-.2):l.current.setXOffset(0))},[M,R]);const K=n.useRef(!0),q=async(e,t)=>{const a=re(e.size/1e3,2);L&&o("toggleFlashlight",{toggled:!1});try{const r=await ye(t?"Video":"Image",e);return t?F(URL.createObjectURL(e),!0):F(r),d("info",`Saved ${t?"video":"photo"} to gallery (${a}kb) - ${r}`),await Ce(r,a),!0}catch(r){throw r}};ee("camera:toggleMicrophone",e=>{m.current&&(m.current.getAudioTracks()[0].enabled=e)}),n.useEffect(()=>{if(K.current){K.current=!1;return}if(L&&!u&&o("toggleFlashlight",{toggled:!1}),!u)return;const e=y.current.captureStream(f.videoOptions.fps),t=new AudioContext,a=new MediaStreamAudioDestinationNode(t);m.current?(o("isTalking").then(C=>{m.current.getAudioTracks()[0].enabled=C}),t.createMediaStreamSource(m.current).connect(a)):t.createOscillator().connect(a);let r;if(f.recordNearbyVoices){r=f.ice?new te({config:{iceTransportPolicy:"relay",iceServers:f.ice}}):new te,r.on("open",h=>{o("Camera",{action:"setRecordingPeerId",peerId:h}),d("info","Listening for nearby voices")});const i=document.createElement("canvas");i.width=1,i.height=1;const C=i.captureStream(0);r.on("call",h=>{h.answer(C),h.on("stream",w=>{d("info","Received nearby voice");const N=new Audio;N.srcObject=w,N.volume=0,N.play(),new MediaStreamAudioSourceNode(t,{mediaStream:w}).connect(a)}),h.on("close",()=>{d("info","Stopped receiving nearby voice")})})}const p=[e.getVideoTracks()[0]];(m.current||f.recordNearbyVoices)&&p.unshift(a.stream.getAudioTracks()[0]);const fe=new MediaStream(p),v=new MediaRecorder(fe,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:f.videoOptions.bitrate*8*1e3});let J=Date.now();const me=v.audioBitsPerSecond+v.videoBitsPerSecond,Y=setInterval(()=>{const i=(Date.now()-J)/1e3,h=me*i/8/1024/1024,w=re(h,2);w>=f.videoOptions.size&&(d("info",`Video file size limit reached (${w}mb)`),clearInterval(Y),k())},100);let Z=[];v.ondataavailable=i=>{Z.push(i.data)},v.onerror=i=>{d("error","error recording:",i)},v.onstop=async()=>{clearInterval(Y);let i=Date.now()-J,C=new Blob(Z,{type:"video/webm"});const h=await ve(C,i,{logger:!1});S(!0),t.close(),r&&(r.destroy(),d("info","Destroyed peer connection"),o("Camera",{action:"endedRecording"}));try{await q(h,!0),S(!1)}catch{S(!1),x(!0),await new Promise(N=>setTimeout(N,1e4)),x(!1)}},v.start();const ge=setInterval(()=>{if(W>=f.videoOptions.duration)return k();Q(i=>i+1>=f.videoOptions.duration?(k(),0):i+1)},1e3);return()=>{Q(0),clearInterval(ge),v.stop()}},[u]);const ue=e=>{let t=(e%60).toString(),a=(Math.floor(e/60)%60).toString(),r=Math.floor(e/3600).toString();return parseInt(r)<10&&(r="0"+r),parseInt(a)<10&&(a="0"+a),parseInt(t)<10&&(t="0"+t),r+":"+a+":"+t},k=async()=>{var t,a;if($)return d("info","Returning since an image is currently uploading");if(L&&await o("toggleFlashlight",{toggled:!0}),c=="Video"){await o("Camera",{action:"toggleHud",toggled:u}),le(r=>!r);return}await o("Camera",{action:"toggleHud",toggled:!1}),(a=(t=D.Settings.value)==null?void 0:t.sound)!=null&&a.silent||D.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),G(!0),T.IndicatorVisible.set(!1),S(!0),d("info","Uploading image, converting to blob");const e=await new Promise(r=>y.current.toBlob(r));try{await q(e,!1),d("info","Image uploaded successfully"),S(!1),T.IndicatorVisible.set(!0)}catch{S(!1),x(!0),T.IndicatorVisible.set(!0),await new Promise(p=>setTimeout(p,1e4)),x(!1)}G(!1),await o("Camera",{action:"toggleHud",toggled:!0})};return s(_,{children:b("div",{className:"camera-container",children:[b("div",{className:"camera-header",children:[s("div",{className:"flash",onClick:()=>H(e=>!e),children:!u&&L?s(Pe,{}):s(Ie,{})}),c==="Video"&&b(_,{children:[s("div",{className:"timer",children:ue(W)}),s("span",{})]})]}),b("div",{className:`camera-body ${c=="Landscape"?"rotate":""}`,children:[s("canvas",{ref:y,style:{visibility:ie?"hidden":"visible"}}),$&&b("div",{className:"loading",children:[s(be,{size:80,speed:1,color:"#ffffff"}),s("div",{className:"uploading",ref:z,children:"Uploading..."})]}),ce&&s("div",{className:"loading",children:s("div",{className:"uploading",children:"Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua"})})]}),b("div",{className:"camera-bottom",children:[s("div",{className:"camera-types",style:de,children:g.map((e,t)=>s("div",{className:`${c===e&&"active"}`,onClick:()=>E(e),children:ae(`APPS.CAMERA.${e.toUpperCase()}`)},t))}),b("div",{className:"camera-buttons",children:[s("div",{className:"image-gallery",ref:U,onClick:()=>{!j&&!M||(o("Camera",{action:"close"}),A(0),D.App.set({name:"Photos"}))}}),s("div",{className:"camera-button",onClick:()=>k(),children:s("div",{className:"camera-button-container",children:s("div",{className:`camera-button-inner ${c=="Video"&&`${c} ${u==!0&&"Recording"}`}`})})}),s("div",{className:"flip-camera",onClick:()=>{X(e=>!e)},children:s(Ae,{})})]})]})]})})}export{xe as default};
